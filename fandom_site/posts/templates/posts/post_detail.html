{% extends 'base.html' %}
{% block content %}
<div class="post-card">
    <div class="post-header">
        <a href="{% url 'user_profile' post.author.username %}">
            <img src="{{ post.author.avatar.url }}" class="avatar">
            <div class="author-info">
                <span class="author-name">{{ post.author.username }}</span>
                <span class="post-date">{{ post.created_at|date:"F j, Y, g:i a" }}</span>
            </div>
        </a>
    </div>

    <h2 class="post-title">{{ post.title }}</h2>
    <p class="post-content">{{ post.content }}</p>

    {% if post.image %}
        <img src="{{ post.image.url }}" class="post-image">
    {% endif %}

    <!-- –õ–∞–π–∫–∏ -->
    <div class="action-buttons">
        <!-- –õ–∞–π–∫ -->
        <button class="action-button {% if user in post.likes.all %}liked{% endif %}" onclick="toggleLike({{ post.id }})" id="like-btn-{{ post.id }}">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path
            d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 
            8.5 2 5.42 4.42 3 7.5 3c1.74 0 
            3.41 0.81 4.5 2.09C13.09 3.81 
            14.76 3 16.5 3 19.58 3 22 5.42 
            22 8.5c0 3.78-3.4 6.86-8.55 
            11.54L12 21.35z"/>
          </svg>
          <span id="like-count-{{ post.id }}">{{ post.likes.count }}</span>
        </button>
      
        <!-- –ò–∑–±—Ä–∞–Ω–Ω–æ–µ -->
        <button class="action-button {% if user in post.favorites.all %}favorited{% endif %}" onclick="toggleFavorite({{ post.id }})" id="favorite-btn-{{ post.id }}">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path
            d="M12 17.27L18.18 21 16.54 13.97 
            22 9.24l-7.19-.61L12 2 9.19 
            8.63 2 9.24l5.46 4.73L5.82 21z"/>
          </svg>
          <span id="favorite-count-{{ post.id }}">{{ post.favorites.count }}</span>
        </button>
        
        <a href="#comments" class="comment-btn">
            üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ post.comments.count }})
        </a>
    </div>

    <hr>

    <h3 id="comments">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ post.comments.count }})</h3>

    <div class="comments-section">
        {% for comment in top_level_comments %}
            {% include 'posts/_comment.html' with comment=comment post=post level=0 %}
        {% empty %}
            <p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.</p>
        {% endfor %}
    </div>

    {% if can_comment %}
        {% if user.is_authenticated %}
            <hr>
            <form method="post" action="{% url 'post_detail' post.pk %}" id="comment-form">
                {% csrf_token %}
                <textarea id="comment-content" name="content" rows="3" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
                <button type="submit">üí¨ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
            </form>                        
        {% else %}
            <p><a href="{% url 'login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å.</p>
        {% endif %}
    {% else %}
        <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∫ —ç—Ç–æ–º—É –ø–æ—Å—Ç—É –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ.</p>
    {% endif %}

    <a href="{% url 'post_list' %}" class="back-btn">‚Üê –ù–∞–∑–∞–¥ –∫ –ø–æ—Å—Ç–∞–º</a>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function toggleLike(postId) {
    fetch(`/posts/post/${postId}/like/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({ post_id: postId })
    })
    .then(response => response.json())
    .then(data => {
        const btn = document.getElementById(`like-btn-${postId}`);
        const countSpan = btn.querySelector('span');
        countSpan.textContent = data.likes_count;

        if (data.liked) {
            btn.classList.add('liked');
        } else {
            btn.classList.remove('liked');
        }
    });
}
function toggleFavorite(postId) {
    fetch(`/posts/post/${postId}/favorite/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({ post_id: postId })
    })
    .then(response => response.json())
    .then(data => {
        const btn = document.getElementById(`favorite-btn-${postId}`);
        const countSpan = btn.querySelector('span');
        countSpan.textContent = data.favorites_count;

        if (data.added) {
            btn.classList.add('favorited');
        } else {
            btn.classList.remove('favorited');
        }
    });
}
</script>
<script>
    document.getElementById('comment-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const content = document.getElementById('comment-content').value;

        fetch("{% url 'post_detail' post.pk %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: new URLSearchParams({
                'content': content
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector('.comments-section').insertAdjacentHTML('beforeend', data.comment_html);
                document.getElementById('comment-content').value = '';
            } else {
                alert("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è");
            }
        });
    });
</script>    
{% endblock %}
