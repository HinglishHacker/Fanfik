{% extends 'base.html' %}

{% block content %}
<div class="post-card">
    <div class="post-header">
        <a href="{% url 'user_profile' post.author.username %}">
            <img src="{{ post.author.avatar.url }}" class="avatar">
            <div class="author-info">
                <span class="author-name">{{ post.author.username }}</span>
                <span class="post-date">{{ post.created_at|date:"F j, Y, g:i a" }}</span>
            </div>
        </a>
    </div>

    <h2 class="post-title">{{ post.title }}</h2>
    <p class="post-content">{{ post.content }}</p>

    {% if post.image %}
        <img src="{{ post.image.url }}" class="post-image">
    {% endif %}

    <div class="post-actions">
        <form method="post" action="{% url 'like_post' %}">
            {% csrf_token %}
            <input type="hidden" name="post_id" value="{{ post.id }}">
            <button type="submit" class="like-btn">
                {% if user in post.likes.all %}
                    ‚ù§Ô∏è
                {% else %}
                    ü§ç
                {% endif %}
                {{ post.likes.count }}
            </button>
        </form>
        
        <form method="post" action="{% url 'toggle_favorite' pk=post.pk %}">
            {% csrf_token %}
            <button type="submit" class="favorite-btn">
                {% if user in post.favorites.all %}
                    –£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ ‚≠ê
                {% else %}
                    –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚≠ê
                {% endif %}
            </button>
        </form>

        <a href="#comments" class="comment-btn">
            üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ post.comments.count }})
        </a>
    </div>

    <hr>

    <h3 id="comments">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ post.comments.count }})</h3>

    <div class="comments-section">
        {% for comment in top_level_comments %}
            {% include 'posts/_comment.html' with comment=comment post=post level=0 %}
        {% empty %}
            <p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.</p>
        {% endfor %}
    </div>

    {% if can_comment %}
        {% if user.is_authenticated %}
            <hr>
            <form method="post" action="{% url 'post_detail' post.pk %}">
                {% csrf_token %}
                <textarea name="content" rows="3" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
                <button type="submit">üí¨ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
            </form>
        {% else %}
            <p><a href="{% url 'login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å.</p>
        {% endif %}
    {% else %}
        <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∫ —ç—Ç–æ–º—É –ø–æ—Å—Ç—É –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ.</p>
    {% endif %}

    <a href="{% url 'post_list' %}" class="back-btn">‚Üê –ù–∞–∑–∞–¥ –∫ –ø–æ—Å—Ç–∞–º</a>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.toggle-replies-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const repliesDiv = document.getElementById(targetId);
                if (repliesDiv.style.display === 'none') {
                    repliesDiv.style.display = 'block';
                    this.classList.add('open');
                    this.innerHTML = '‚ñº –°–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç—ã';
                } else {
                    repliesDiv.style.display = 'none';
                    this.classList.remove('open');
                    this.innerHTML = '‚ñ∂ –ü–æ–∫–∞–∑–∞—Ç—å ' + repliesDiv.children.length + ' –æ—Ç–≤–µ—Ç(–æ–≤)';
                }
            });
        });

        document.querySelectorAll('.reply-link').forEach(function(link) {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                const commentId = this.getAttribute('data-comment-id');
                const replyForm = document.getElementById('reply-form-' + commentId);
                replyForm.style.display = (replyForm.style.display === 'none') ? 'block' : 'none';
            });
        });
    });
</script>
{% endblock %}
