{% extends 'base.html' %}

{% block content %}
<h2>{{ post.title }}</h2>

<div>
    <a href="{% url 'user_profile' post.author.username %}">
        <img src="{{ post.author.avatar.url }}" width="40" height="40" style="border-radius: 50%;">
        {{ post.author.username }}
    </a>
    <p>{{ post.content }}</p>

    {% if post.image %}
        <img src="{{ post.image.url }}" style="max-width: 400px;">
    {% endif %}

    <p>‚ù§Ô∏è {{ post.likes.count }} –ª–∞–π–∫–æ–≤</p>

    {% if user.is_authenticated %}
        <form method="post" action="{% url 'like_post' %}">
            {% csrf_token %}
            <input type="hidden" name="post_id" value="{{ post.id }}">
            <button type="submit">
                {% if user in post.likes.all %}
                    ‚ù§Ô∏è
                {% else %}
                    ü§ç
                {% endif %}
                {{ post.likes.count }}
            </button>
        </form>
        <form method="post" action="{% url 'toggle_favorite' pk=post.pk %}">
            {% csrf_token %}
            {% if user in post.favorites.all %}
                <button type="submit">–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ ‚≠ê</button>
            {% else %}
                <button type="submit">–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚≠ê</button>
            {% endif %}
        </form>        
    {% endif %}
</div>

<hr>

<h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ post.comments.count }})</h3>

{% for comment in top_level_comments %}
    <div class="comment">
        <strong>{{ comment.user.username }}</strong>: {{ comment.content }}
        <div class="comment-time">{{ comment.created_at }}</div>

        <!-- –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤ -->
        {% if comment.replies.count > 0 %}
            <a href="#" class="show-replies" data-comment-id="{{ comment.id }}">
                –ü–æ–∫–∞–∑–∞—Ç—å {{ comment.replies.count }} –æ—Ç–≤–µ—Ç(–æ–≤)
            </a>
            <div class="replies" id="replies-{{ comment.id }}" style="display: none;">
                {% for reply in comment.replies.all %}
                    <div class="reply">
                        <strong>{{ reply.user.username }}</strong>: {{ reply.content }}
                        <div class="comment-time">{{ reply.created_at }}</div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ -->
        <form method="post" action="{% url 'add_comment' post.pk %}" class="reply-form" id="reply-form-{{ comment.id }}" style="display: none; margin-top: 5px;">
            {% csrf_token %}
            <textarea name="content" rows="2" style="width: 100%;" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..."></textarea>
            <input type="hidden" name="parent_id" value="{{ comment.id }}">
            <button type="submit">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
        </form>

        <!-- –ö–Ω–æ–ø–∫–∞ "–û—Ç–≤–µ—Ç–∏—Ç—å" -->
        <a href="#" class="reply-link" data-comment-id="{{ comment.id }}">–û—Ç–≤–µ—Ç–∏—Ç—å</a>
    </div>
{% empty %}
    <p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.</p>
{% endfor %}

{% if can_comment %}
    {% if user.is_authenticated %}
        <hr>
        <form method="post" action="{% url 'post_detail' post.pk %}">
            {% csrf_token %}
            <textarea name="content" rows="3" style="width: 100%;" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
            <button type="submit">üí¨ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
        </form>
    {% else %}
        <p><a href="{% url 'login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å.</p>
    {% endif %}
{% else %}
    <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∫ —ç—Ç–æ–º—É –ø–æ—Å—Ç—É –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ.</p>
{% endif %}

<a href="{% url 'post_list' %}" style="display: block; margin-top: 20px;">‚Üê –ù–∞–∑–∞–¥ –∫ –ø–æ—Å—Ç–∞–º</a>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ "–ü–æ–∫–∞–∑–∞—Ç—å X –æ—Ç–≤–µ—Ç–æ–≤"
        document.querySelectorAll('.show-replies').forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                const commentId = this.getAttribute('data-comment-id');
                const repliesDiv = document.getElementById('replies-' + commentId);
                repliesDiv.style.display = (repliesDiv.style.display === 'none') ? 'block' : 'none';
                this.textContent = (repliesDiv.style.display === 'none') 
                    ? '–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç—ã' 
                    : '–°–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç—ã';
            });
        });

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ "–û—Ç–≤–µ—Ç–∏—Ç—å"
        document.querySelectorAll('.reply-link').forEach(function(link) {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                const commentId = this.getAttribute('data-comment-id');
                const replyForm = document.getElementById('reply-form-' + commentId);
                replyForm.style.display = (replyForm.style.display === 'none') ? 'block' : 'none';
            });
        });
    });
</script>

{% endblock %}
